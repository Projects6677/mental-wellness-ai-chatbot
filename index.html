<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindMate ‚Äî Youth Mental Wellness</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a1a;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            transition: background-color 0.5s ease;
        }
        .chat-container {
            height: calc(100vh - 8rem);
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .chat-container::-webkit-scrollbar {
            display: none;
        }
        .calendar-day {
            width: 2.2rem;
            height: 2.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            color: #e0e0e0;
            position: relative;
        }
        .mood-dot {
            position: absolute;
            bottom: 0.2rem;
            right: 0.2rem;
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
        }
        #chart-container canvas {
            max-width: 100%;
        }
        /* Custom scrollbar for demo purposes */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 4px;
        }
        @keyframes pulse-breathing {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0.5; }
        }
        .animate-pulse-breathing {
            animation: pulse-breathing 4s infinite ease-in-out;
        }
        .badge-icon {
            font-size: 2rem;
            line-height: 1;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .modal-content {
            background-color: #1f2937;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 600px;
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden bg-gray-900 text-white">
    <!-- Main UI Container -->
    <div class="flex h-screen">

        <!-- Sidebar -->
        <aside class="w-64 flex-shrink-0 bg-gray-900 border-r border-gray-700 p-4 flex flex-col overflow-y-auto">
            <div class="flex items-center gap-2 mb-6">
                <span class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center font-bold text-white">MM</span>
                <span class="text-xl font-semibold">MindMate</span>
            </div>
            
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors mb-2" onclick="clearSession()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                New Session
            </button>
            <button class="w-full bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors mb-4" onclick="clearChat()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                Clear Chat
            </button>


            <!-- Daily Check-In & Mood Journal -->
            <div class="flex-shrink-0 pb-4 border-b border-gray-700">
                <div class="text-sm text-gray-400 font-semibold mb-2">Mood Check-in</div>
                <div class="space-y-2 mb-4" id="mood-selector">
                    <div class="mood-option flex items-center p-2 rounded-lg cursor-pointer bg-gray-800 hover:bg-gray-700 transition-colors" data-mood="üòä Happy">
                        <span class="text-2xl mr-2">üòä</span> Happy
                    </div>
                    <div class="mood-option flex items-center p-2 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors" data-mood="üòî Sad">
                        <span class="text-2xl mr-2">üòî</span> Sad
                    </div>
                    <div class="mood-option flex items-center p-2 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors" data-mood="üò® Anxious">
                        <span class="text-2xl mr-2">üò®</span> Anxious
                    </div>
                    <div class="mood-option flex items-center p-2 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors" data-mood="üò° Angry">
                        <span class="text-2xl mr-2">üò°</span> Angry
                    </div>
                    <div class="mood-option flex items-center p-2 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors" data-mood="üòê Neutral">
                        <span class="text-2xl mr-2">üòê</span> Neutral
                    </div>
                    <div class="mood-option flex items-center p-2 rounded-lg cursor-pointer hover:bg-gray-700 transition-colors" data-mood="üòü Stressed">
                        <span class="text-2xl mr-2">üòü</span> Stressed
                    </div>
                </div>
                <button class="w-full bg-gray-700 hover:bg-gray-600 text-white py-1 px-4 rounded-lg text-sm mb-2" onclick="showJournalVault()">Journaling Vault</button>
                <button class="w-full bg-gray-700 hover:bg-gray-600 text-white py-1 px-4 rounded-lg text-sm mb-2" onclick="startGuidedBreathing()">Breathing Exercise</button>
                <button class="w-full bg-red-700 hover:bg-red-600 text-white py-1 px-4 rounded-lg text-sm mb-2" onclick="showSosPlan()">Quick SOS Plan</button>
            </div>
            
            <!-- Mood Calendar & Streak -->
            <div class="mt-4 flex-shrink-0 border-b border-gray-700 pb-4">
                <p class="text-sm text-gray-400 font-semibold mb-2">My Progress</p>
                <div id="shareable-card" class="bg-gray-800 rounded-lg p-2 mb-2">
                    <p class="text-sm text-gray-400">Current Streak:</p>
                    <p class="text-xl font-bold text-green-400 mb-2" id="streak-counter">0 day(s)</p>
                    <div class="text-sm text-gray-400">My Goal:</div>
                    <p class="text-lg font-bold truncate text-yellow-400" id="goal-display">Not set</p>
                </div>
                <button class="w-full bg-gray-700 hover:bg-gray-600 text-white py-1 px-4 rounded-lg text-sm mb-2" onclick="shareProgress()">
                    Share Progress
                </button>
                <button class="w-full bg-gray-700 hover:bg-gray-600 text-white py-1 px-4 rounded-lg text-sm mb-2" onclick="showMoodChart()">
                    Show Mood Chart
                </button>
                <button class="w-full bg-gray-700 hover:bg-gray-600 text-white py-1 px-4 rounded-lg text-sm mb-2" onclick="generateSummary()">
                    AI Summary
                </button>

                <div id="mood-calendar" class="grid grid-cols-7 gap-1 mt-4">
                    <!-- Calendar days will be rendered here -->
                </div>
                <div class="flex items-center justify-between mt-4">
                    <button class="text-gray-400 hover:text-white" onclick="changeMonth(-1)">&#9664;</button>
                    <span id="current-month" class="text-sm font-medium"></span>
                    <button class="text-gray-400 hover:text-white" onclick="changeMonth(1)">&#9654;</button>
                </div>
            </div>

            <!-- AI Personas & Daily Affirmation -->
            <div class="mt-4 flex-shrink-0 border-b border-gray-700 pb-4">
                <div class="text-sm text-gray-400 font-semibold mb-2">Daily Affirmation</div>
                <div id="daily-affirmation" class="p-2 bg-gray-800 rounded-lg text-sm italic text-gray-300 mb-4"></div>
            </div>
            
            <div class="mt-4 flex-shrink-0 border-b border-gray-700 pb-4">
                <div class="text-sm text-gray-400 font-semibold mb-2">AI Buddy Persona</div>
                <select id="persona-selector" class="w-full bg-gray-800 rounded-lg p-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="calm_listener">Calm Listener</option>
                    <option value="motivational_coach">Motivational Coach</option>
                    <option value="gentle_friend">Gentle Friend</option>
                </select>
                <div class="text-sm text-gray-400 font-semibold mt-4 mb-2">My Goals</div>
                <input type="text" id="goal-input" class="w-full bg-gray-800 text-white rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-500" placeholder="e.g., Run a 5K, Learn to code...">
                <button class="w-full mt-2 bg-gray-700 hover:bg-gray-600 text-white py-1 px-4 rounded-lg text-sm" onclick="saveGoal()">Set Goal</button>
            </div>
            
            <!-- AI Buddy Avatar -->
            <div class="mt-4 flex-shrink-0 border-b border-gray-700 pb-4">
                <div class="text-sm text-gray-400 font-semibold mb-2">Buddy Avatar</div>
                <div class="flex justify-around items-center space-x-2">
                    <button class="bg-gray-800 hover:bg-gray-700 p-2 rounded-lg transition-colors text-3xl" onclick="changeAvatar('robot')">ü§ñ</button>
                    <button class="bg-gray-800 hover:bg-gray-700 p-2 rounded-lg transition-colors text-3xl" onclick="changeAvatar('cat')">üê±</button>
                    <button class="bg-gray-800 hover:bg-gray-700 p-2 rounded-lg transition-colors text-3xl" onclick="changeAvatar('owl')">ü¶â</button>
                </div>
            </div>

            <!-- Badges -->
            <div class="mt-4 flex-shrink-0 pb-4 border-b border-gray-700">
                <div class="text-sm text-gray-400 font-semibold mb-2">My Badges</div>
                <div id="badge-container" class="flex flex-wrap gap-2">
                    <!-- Badges will be rendered here -->
                </div>
            </div>

            <!-- Wellness Challenges -->
            <div class="mt-4 flex-shrink-0 pb-4">
                <div class="text-sm text-gray-400 font-semibold mb-2">Wellness Challenge</div>
                <div id="challenge-container" class="bg-gray-800 rounded-lg p-4">
                    <p class="text-lg font-semibold mb-2">7-Day Wellness Challenge</p>
                    <div id="challenge-days" class="flex justify-between text-sm mb-2"></div>
                    <p id="current-challenge-task" class="text-sm italic text-gray-400"></p>
                    <button class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white py-1 px-4 rounded-lg text-sm" onclick="completeChallengeDay()">
                        Complete Day <span id="current-day-num">1</span>
                    </button>
                </div>
            </div>
            
            <!-- Community Board (Simulated) -->
            <div class="mt-4 flex-shrink-0 pb-4">
                <div class="text-sm text-gray-400 font-semibold mb-2">Community Board (Simulated)</div>
                <button class="w-full bg-gray-700 hover:bg-gray-600 text-white py-1 px-4 rounded-lg text-sm" onclick="showCommunityBoard()">
                    View Board
                </button>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="flex-grow flex flex-col bg-gray-800">
            <!-- Header -->
            <header class="p-4 border-b border-gray-700 flex items-center justify-between flex-shrink-0">
                <h1 class="text-xl font-semibold">MindMate Chat</h1>
                <div class="text-sm text-gray-400 flex items-center space-x-2">
                    <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-1 px-3 rounded-full transition-colors" id="voice-input-btn" onclick="toggleVoiceInput()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mic"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                    </button>
                    <button class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-1 px-3 rounded-full transition-colors" onclick="toggleVentingMode()">Start Venting</button>
                    <button id="vent-btn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-1 px-3 rounded-full transition-colors hidden" onclick="toggleVentingMode()">Venting Mode: On</button>
                    <button id="stop-speaking-btn" class="bg-red-600 hover:bg-red-700 text-white font-medium py-1 px-3 rounded-full transition-colors" onclick="stopSpeaking()">Stop Speaking</button>
                </div>
            </header>
            
            <!-- Chat Container -->
            <div id="chat-container" class="chat-container flex flex-col p-6 space-y-4 flex-grow overflow-y-auto">
                <!-- Chat messages will be dynamically added here -->
            </div>

            <!-- Floating Button -->
            <button id="floating-btn" class="fixed bottom-24 right-6 w-12 h-12 bg-purple-600 hover:bg-purple-700 text-white rounded-full flex items-center justify-center shadow-lg transition-colors z-50" onclick="getMotivationalQuote()">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-zap"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
            </button>


            <!-- Modals -->
            <!-- Modal for Guided Meditation -->
            <div id="meditation-modal" class="modal hidden">
                <div class="modal-content text-center">
                    <h2 class="text-2xl font-bold mb-4">Guided Meditation</h2>
                    <p id="meditation-text" class="text-lg mb-4">Click Play to begin.</p>
                    <button id="meditation-toggle-btn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg">Play</button>
                    <button class="bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded-lg ml-2" onclick="closeModal('meditation-modal')">Close</button>
                </div>
            </div>

            <!-- Modal for Mood Chart -->
            <div id="mood-chart-modal" class="modal hidden">
                <div class="modal-content">
                    <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-4">
                        <h2 class="text-xl font-semibold">Weekly Mood Trends</h2>
                        <button class="text-gray-400 hover:text-white" onclick="closeModal('mood-chart-modal')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6L6 18"/><path d="M6 6L18 18"/></svg>
                        </button>
                    </div>
                    <canvas id="mood-chart"></canvas>
                </div>
            </div>
            
            <!-- Modal for Journaling Vault -->
            <div id="journal-modal" class="modal hidden">
                <div class="modal-content flex flex-col max-h-[80vh]">
                    <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-4">
                        <h2 class="text-xl font-semibold">Your Private Journal</h2>
                        <button class="text-gray-400 hover:text-white" onclick="closeModal('journal-modal')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6L6 18"/><path d="M6 6L18 18"/></svg>
                        </button>
                    </div>
                    <textarea id="journal-entry" class="flex-grow w-full p-4 bg-gray-700 rounded-lg text-white resize-none" placeholder="Write your thoughts here..."></textarea>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg" onclick="saveJournalEntry()">Save</button>
                    </div>
                </div>
            </div>

            <!-- PIN Lock Modal -->
            <div id="pin-modal" class="modal hidden">
                <div class="modal-content text-center">
                    <h2 class="text-2xl font-bold mb-4">Enter PIN</h2>
                    <input type="password" id="pin-input" class="w-48 bg-gray-800 text-white rounded-lg p-2 text-xl tracking-[1rem] text-center focus:outline-none focus:ring-2 focus:ring-blue-500" maxlength="4">
                    <div class="mt-4 flex justify-center space-x-2">
                        <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg" onclick="checkPin()">Enter</button>
                        <button class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg" onclick="closeModal('pin-modal')">Cancel</button>
                    </div>
                    <div id="pin-error" class="text-red-400 mt-2 hidden">Incorrect PIN. Try again.</div>
                </div>
            </div>

            <!-- Set PIN Modal -->
            <div id="set-pin-modal" class="modal hidden">
                <div class="modal-content text-center">
                    <h2 class="text-2xl font-bold mb-4">Set a 4-Digit PIN</h2>
                    <input type="password" id="set-pin-input" class="w-48 bg-gray-800 text-white rounded-lg p-2 text-xl tracking-[1rem] text-center focus:outline-none focus:ring-2 focus:ring-blue-500" maxlength="4">
                    <div class="mt-4 flex justify-center space-x-2">
                        <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg" onclick="setPin()">Set</button>
                        <button class="bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg" onclick="closeModal('set-pin-modal')">Cancel</button>
                    </div>
                </div>
            </div>
            
            <!-- Modal for Community Board -->
            <div id="community-modal" class="modal hidden">
                <div class="modal-content flex flex-col max-h-[80vh]">
                    <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-4">
                        <h2 class="text-xl font-semibold">Community Board</h2>
                        <button class="text-gray-400 hover:text-white" onclick="closeModal('community-modal')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6L6 18"/><path d="M6 6L18 18"/></svg>
                        </button>
                    </div>
                    <div id="community-posts" class="flex-grow overflow-y-auto mb-4 space-y-4">
                        <!-- Community posts will be rendered here -->
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="community-input" class="flex-grow bg-gray-700 text-white rounded-lg py-2 px-3 focus:outline-none" placeholder="Post an inspiring thought...">
                        <button class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg" onclick="postToCommunity()">Post</button>
                    </div>
                </div>
            </div>

            <!-- SOS Plan Modal -->
            <div id="sos-modal" class="modal hidden">
                <div class="modal-content">
                    <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-4">
                        <h2 class="text-xl font-semibold">Your Quick SOS Plan</h2>
                        <button class="text-gray-400 hover:text-white" onclick="closeModal('sos-modal')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6L6 18"/><path d="M6 6L18 18"/></svg>
                        </button>
                    </div>
                    <textarea id="sos-plan-input" class="w-full h-40 bg-gray-700 rounded-lg text-white p-4 resize-none" placeholder="Write down your coping steps here. e.g., Call a friend, take a walk, listen to music..."></textarea>
                    <div class="mt-4 flex justify-end space-x-2">
                        <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg" onclick="saveSosPlan()">Save Plan</button>
                    </div>
                </div>
            </div>

            <!-- Crisis Detection Card -->
            <div id="crisis-card" class="hidden p-4 mx-6 my-4 bg-red-800 rounded-lg shadow-lg">
                <p class="text-lg font-semibold mb-2">‚ö†Ô∏è Immediate Help Needed</p>
                <p class="text-sm">I detect language suggesting severe distress. If you are in immediate danger, please reach out to the resources below. You are not alone.</p>
                <div id="sos-plan-display" class="mt-4 text-xs font-medium bg-red-700 p-2 rounded-lg italic hidden"></div>
                <div id="crisis-resources" class="mt-4 text-xs font-medium"></div>
            </div>

            <!-- Quick Tip Card -->
            <div id="tip-card" class="hidden p-4 mx-6 my-4 bg-blue-800 rounded-lg shadow-lg">
                <p class="text-lg font-semibold mb-2">üå± Quick Tip</p>
                <p class="text-sm" id="tip-content"></p>
                <div class="flex flex-col space-y-2 mt-2" id="playlist-container">
                    <p class="text-sm text-blue-200">Loading playlist...</p>
                </div>
            </div>
            
            <!-- Breathing Exercise Modal -->
            <div id="breathing-modal" class="modal hidden">
                <div class="modal-content text-center">
                    <h2 class="text-2xl font-bold mb-4">Mindful Breathing</h2>
                    <div id="breathing-circle-container" class="flex justify-center items-center h-48">
                        <div id="breathing-circle" class="w-24 h-24 bg-blue-500 rounded-full animate-pulse-breathing"></div>
                    </div>
                    <div id="breathing-text" class="text-xl font-bold mt-4">Breathe In...</div>
                    <button class="mt-6 bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded-lg" onclick="stopBreathing()">Stop</button>
                </div>
            </div>


            <!-- Chat Input Area -->
            <div class="p-4 flex-shrink-0 bg-gray-900 border-t border-gray-700">
                <div class="relative flex items-center">
                    <input type="text" id="user-input" class="w-full bg-gray-800 text-white rounded-xl py-3 px-4 pr-16 focus:outline-none focus:ring-2 focus:ring-blue-500 placeholder-gray-500" placeholder="Ask MindMate anything..." onkeydown="handleInput(event)">
                    <button id="send-btn" class="absolute right-2 bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full transition-colors" onclick="sendMessage()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><path d="m22 2-7 19-7-19-3 3v13"/></svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Data and Configuration
        // IMPORTANT: Paste your actual API key below.
        const API_KEY = "AIzaSyBpqaidvMZFtPslwJO75hBfz2GDaKcjnUY"; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        const BASE_SYSTEM_PROMPT = `
            You are MindMate, a compassionate, non-judgmental conversational assistant. Your job is to listen actively, reflect feelings, validate the user's experience, and offer short, practical coping strategies or resources.
            Keep replies concise, empathetic, and avoid medical jargon. Encourage seeking professional help when appropriate, and clearly advise contacting emergency services if the user appears to be in danger.
        `;
        const HELPLINES = [
            // Indian Helplines
            { "country": "India", "service": "Aasra", "number": "91-98204-66726", "url": "http://www.aasra.info/" },
            { "country": "India", "service": "Vandrevala Foundation", "number": "91-73045-21444", "url": "https://www.vandrevalafoundation.com/" },
            // Global/Other Helplines
            { "country": "Global", "service": "Befrienders Worldwide (find local centers)", "url": "https://www.befrienders.org/" },
            { "country": "US", "service": "National Suicide & Crisis Lifeline", "number": "988", "url": "https://988lifeline.org/" },
            { "country": "UK", "service": "Samaritans", "number": "116 123", "url": "https://www.samaritans.org/" }
        ];
        const CRISIS_PATTERNS = [
            /suicid/i, /kill myself/i, /end my life/i, /want to die/i, /hurt myself/i,
            /self[- ]harm/i, /overdose/i, /hang myself/i, /i'll die/i, /no reason to live/i
        ];
        const MOOD_SUGGESTIONS = {
            "üòä Happy": "Celebrate! Jot down one thing that made you smile ‚Äî savor it for 60 seconds. Acknowledge what makes you feel good. ",
            "üòî Sad": "Try a 3-2-1 grounding: name 3 things you see, 2 things you can touch, 1 thing you can hear. This helps bring you back to the present moment.",
            "üò® Anxious": "Try box breathing: inhale for 4 seconds, hold for 4, exhale for 4, hold for 4 ‚Äî repeat 4 times. This can calm your nervous system.",
            "üò° Angry": "Step away for 2 mins. Put your hands on your belly and take slow breaths to calm your body. Physical distance from the situation can help.",
            "üòê Neutral": "Take a 2-minute mindful break: notice your breath and your surroundings. It's a great way to reset and be present.",
            "üòü Stressed": "Break tasks into tiny steps ‚Äî write one next tiny action you can finish in 5 minutes. Small steps add up to big progress.",
        };
        const MOODS = ["üòä Happy", "üòî Sad", "üò® Anxious", "üò° Angry", "üòê Neutral", "üòü Stressed"];
        const MOOD_COLORS = {
            "üòä Happy": "rgb(34, 197, 94)",
            "üòî Sad": "rgb(96, 165, 250)",
            "üò® Anxious": "rgb(249, 115, 22)",
            "üò° Angry": "rgb(239, 68, 68)",
            "üòê Neutral": "rgb(148, 163, 184)",
            "üòü Stressed": "rgb(250, 204, 21)",
        };
        const MOOD_SCORES = {
            "üòä Happy": 5, "üòî Sad": 1, "üò® Anxious": 2, "üò° Angry": 1, "üòê Neutral": 3, "üòü Stressed": 2,
        };
        const PERSONAS = {
            calm_listener: {
                name: "Calm Listener",
                prompt: "You are a very calm, patient, and soothing conversational partner. Your replies are gentle and focus on active listening and validation. You use quiet, reassuring language."
            },
            motivational_coach: {
                name: "Motivational Coach",
                prompt: "You are an energetic and motivating life coach. Your replies are encouraging, solution-oriented, and focused on helping the user take small, positive actions. You use empowering language and offer a lot of praise."
            },
            gentle_friend: {
                name: "Gentle Friend",
                prompt: "You are a gentle and supportive friend. Your replies are conversational and friendly, offering peer-to-peer support. You use casual, warm, and comforting language."
            }
        };
        const AVATARS = {
            robot: "ü§ñ",
            cat: "üê±",
            owl: "ü¶â"
        };
        const CHALLENGES = [
            "Write down three things you are grateful for today.",
            "Take a 5-minute break and focus on your breathing. Inhale for 4, exhale for 4.",
            "List one small task you've been putting off and complete it.",
            "Connect with someone you care about. Send a thoughtful text or make a quick call.",
            "Spend 10 minutes outside and pay attention to your surroundings.",
            "Listen to a favorite song and just focus on the music.",
            "Try a new healthy snack or drink. A small change can make a big difference."
        ];
        const BADGES = {
            'streak_7': { emoji: 'üî•', title: '7-Day Streak', desc: 'Maintained a check-in streak for 7 days.' },
            'challenge_complete': { emoji: 'üèÜ', title: 'Challenge Master', desc: 'Completed the 7-day wellness challenge.' },
            'first_journal': { emoji: '‚úçÔ∏è', title: 'First Journal', desc: 'Wrote your first private journal entry.' },
            'breathing_5': { emoji: 'üßò', title: 'Mindful Master', desc: 'Completed 5 mindful breathing exercises.' },
        };
        const AFFIRMATIONS = [
            "You are stronger than you think. Today, focus on progress, not perfection.",
            "Your feelings are valid. Take a moment to acknowledge them without judgment.",
            "Small steps lead to great distances. Celebrate every little victory.",
            "You have the power to create a peaceful space within yourself.",
            "Be kind to yourself today. You are doing the best you can."
        ];
        const GUIDED_MEDITATION_TEXT = [
            "Welcome. Find a comfortable position. Close your eyes or soften your gaze.",
            "Take a deep breath in through your nose, filling your lungs completely.",
            "Hold that breath for a moment, and now, slowly release it through your mouth.",
            "Again, inhale deeply... and exhale slowly.",
            "Feel your body relax with each breath. Let go of any tension you might be holding.",
            "Just for this moment, let your mind be quiet. Focus only on the rhythm of your breath.",
            "Inhale peace. Exhale stress.",
            "You are doing a great job. When you are ready, gently open your eyes.",
            "You can return to this feeling of calm whenever you need it. The meditation is now complete."
        ];
        const COGNITIVE_DISTORTIONS = {
             "i'm a failure": "That's a tough thought to have. While you might feel like a failure, remember that one setback doesn't define your entire worth. What's one small step you can take forward today?",
             "i always mess up": "It's easy to focus on mistakes, but think about all the times you've succeeded. It's not a matter of 'always' messing up, but rather, learning from moments that didn't go as planned.",
             "no one likes me": "It's painful to feel alone. But remember, the way you see yourself isn't always how others see you. There are people who care about you. What's one way you can connect with someone today?",
             "it's hopeless": "I know it feels hopeless right now, but that's a feeling, not a fact. Small changes can create big shifts over time. What's the tiniest possible action you could take right now to move forward?",
        };
        const MOOD_PLAYLISTS = {
            "üòä Happy": "https://www.youtube.com/embed/videoseries?list=PL_XqGkYnK1uP7Wf5yY_X-a3v3zB_Pq6jO",
            "üòî Sad": "https://www.youtube.com/embed/videoseries?list=PL_XqGkYnK1uPEr25K-z73c3wQpP9hY9yY",
            "üò® Anxious": "https://www.youtube.com/embed/videoseries?list=PL_XqGkYnK1uM2yD_g-2q2e-7iP5x_P-zV",
            "üò° Angry": "https://www.youtube.com/embed/videoseries?list=PL_XqGkYnK1uO-G-X-v86i_J-7jY_g-R-Y",
            "üòê Neutral": "https://www.youtube.com/embed/videoseries?list=PL_XqGkYnK1uN5c5wF-2w3g-j-3j_1y-3j",
            "üòü Stressed": "https://www.youtube.com/embed/videoseries?list=PL_XqGkYnK1uP8h5g-y-2c-7i-j-1a-5c",
        };


        let chatHistory = [];
        let mood = "üòä Happy";
        let ventingMode = false;
        let recognition = null;
        let isListening = false;
        let synthesis = window.speechSynthesis;
        let currentCalendarDate = new Date();
        let myChart = null;
        let chatTimer = null;
        let pin = null;
        let breathingTimer = null;
        
        // UI Elements
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const moodOptions = document.querySelectorAll('.mood-option');
        const streakCounter = document.getElementById('streak-counter');
        const tipCard = document.getElementById('tip-card');
        const tipContent = document.getElementById('tip-content');
        const crisisCard = document.getElementById('crisis-card');
        const crisisResources = document.getElementById('crisis-resources');
        const ventBtn = document.getElementById('vent-btn');
        const goalInput = document.getElementById('goal-input');
        const personaSelector = document.getElementById('persona-selector');
        const moodCalendar = document.getElementById('mood-calendar');
        const currentMonthDisplay = document.getElementById('current-month');
        const challengeDaysContainer = document.getElementById('challenge-days');
        const currentChallengeTask = document.getElementById('current-challenge-task');
        const currentDayNum = document.getElementById('current-day-num');
        const meditationModal = document.getElementById('meditation-modal');
        const meditationText = document.getElementById('meditation-text');
        const meditationToggleBtn = document.getElementById('meditation-toggle-btn');
        const voiceInputBtn = document.getElementById('voice-input-btn');
        const moodChartModal = document.getElementById('mood-chart-modal');
        const badgeContainer = document.getElementById('badge-container');
        const goalDisplay = document.getElementById('goal-display');
        const dailyAffirmation = document.getElementById('daily-affirmation');
        const communityPostsContainer = document.getElementById('community-posts');
        const communityInput = document.getElementById('community-input');
        const sendBtn = document.getElementById('send-btn');
        const stopSpeakingBtn = document.getElementById('stop-speaking-btn');
        const sosPlanInput = document.getElementById('sos-plan-input');
        const sosPlanDisplay = document.getElementById('sos-plan-display');
        const breathingModal = document.getElementById('breathing-modal');
        const breathingCircle = document.getElementById('breathing-circle');
        const breathingText = document.getElementById('breathing-text');
        const pinModal = document.getElementById('pin-modal');
        const pinInput = document.getElementById('pin-input');
        const pinError = document.getElementById('pin-error');
        const setPinModal = document.getElementById('set-pin-modal');
        const setPinInput = document.getElementById('set-pin-input');

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });
        
        function initializeApp() {
            loadState();
            updateStreak();
            updateMoodCalendar();
            selectMood("üòä Happy");
            displayInitialMessage();
            renderChallenges();
            renderBadges();
            updateGoalDisplay();
            displayDailyAffirmation();
            renderCommunityPosts();
        }

        // --- Core Functions ---
        function loadState() {
            const storedGoal = localStorage.getItem('userGoal');
            if (storedGoal) {
                goalInput.value = storedGoal;
            }
        }

        function saveState() {
            localStorage.setItem('userGoal', goalInput.value);
            updateGoalDisplay();
        }

        function updateGoalDisplay() {
            const storedGoal = localStorage.getItem('userGoal');
            if (storedGoal && storedGoal !== "") {
                goalDisplay.textContent = storedGoal;
            } else {
                goalDisplay.textContent = "Not set";
            }
        }
        
        function clearSession() {
            localStorage.clear();
            chatHistory = [];
            mood = "üòä Happy";
            ventingMode = false;
            chatContainer.innerHTML = '';
            tipCard.classList.add('hidden');
            crisisCard.classList.add('hidden');
            ventBtn.classList.add('hidden');
            goalInput.value = '';
            updateStreak();
            updateMoodCalendar();
            selectMood("üòä Happy");
            displayInitialMessage();
            renderChallenges();
            renderBadges();
            updateGoalDisplay();
        }

        function clearChat() {
            chatHistory = [];
            chatContainer.innerHTML = '';
            displayInitialMessage();
            tipCard.classList.add('hidden');
            crisisCard.classList.add('hidden');
        }

        function updateStreak() {
            const today = new Date().toDateString();
            let storedLastCheckin = localStorage.getItem('lastCheckin');
            let storedStreak = parseInt(localStorage.getItem('streak') || '0', 10);
            
            if (storedLastCheckin && storedLastCheckin !== today) {
                const oneDay = 24 * 60 * 60 * 1000;
                const lastDate = new Date(storedLastCheckin);
                const diffDays = Math.round(Math.abs((new Date() - lastDate) / oneDay));
                if (diffDays === 1) {
                    storedStreak += 1;
                } else {
                    storedStreak = 1; // Reset streak
                }
            } else if (!storedLastCheckin) {
                storedStreak = 1;
            }

            localStorage.setItem('lastCheckin', today);
            localStorage.setItem('streak', storedStreak.toString());
            streakCounter.textContent = `${storedStreak} day(s)`;
            
            if (storedStreak >= 7 && !getBadgeStatus('streak_7')) {
                grantBadge('streak_7');
            }
        }
        
        function getSentiment(text) {
            const lowerText = text.toLowerCase();
            if (lowerText.includes('happy') || lowerText.includes('great') || lowerText.includes('good') || lowerText.includes('excited') || lowerText.includes('joy')) return "üòä Happy";
            if (lowerText.includes('sad') || lowerText.includes('unhappy') || lowerText.includes('lonely') || lowerText.includes('depressed')) return "üòî Sad";
            if (lowerText.includes('anxious') || lowerText.includes('worried') || lowerText.includes('nervous') || lowerText.includes('scared')) return "üò® Anxious";
            if (lowerText.includes('angry') || lowerText.includes('mad') || lowerText.includes('frustrated') || lowerText.includes('irritated')) return "üò° Angry";
            if (lowerText.includes('stressed') || lowerText.includes('overwhelmed') || lowerText.includes('exhausted')) return "üòü Stressed";
            return "üòê Neutral";
        }

        // --- Badges ---
        function getBadges() {
            return JSON.parse(localStorage.getItem('badges') || '[]');
        }

        function getBadgeStatus(badgeId) {
            const badges = getBadges();
            return badges.includes(badgeId);
        }

        function grantBadge(badgeId) {
            const badges = getBadges();
            if (!badges.includes(badgeId)) {
                badges.push(badgeId);
                localStorage.setItem('badges', JSON.stringify(badges));
                addMessage("system", `üéâ Congratulations! You earned a new badge: **${BADGES[badgeId].title}**!`);
                renderBadges();
            }
        }

        function renderBadges() {
            badgeContainer.innerHTML = '';
            const badges = getBadges();
            if (badges.length === 0) {
                badgeContainer.innerHTML = `<p class="text-sm text-gray-500 italic">No badges earned yet. Keep going!</p>`;
            }
            badges.forEach(badgeId => {
                const badgeInfo = BADGES[badgeId];
                const badgeDiv = document.createElement('div');
                badgeDiv.className = 'flex flex-col items-center bg-gray-800 p-2 rounded-lg text-xs w-16 text-center';
                badgeDiv.innerHTML = `
                    <span class="badge-icon">${badgeInfo.emoji}</span>
                    <span class="mt-1 font-semibold">${badgeInfo.title}</span>
                `;
                badgeContainer.appendChild(badgeDiv);
            });
        }

        // --- Mood Journal & Calendar ---
        function saveMoodEntry(selectedMood) {
            let moodJournal = JSON.parse(localStorage.getItem('moodJournal') || '{}');
            const today = new Date().toISOString().split('T')[0];
            moodJournal[today] = selectedMood;
            localStorage.setItem('moodJournal', JSON.stringify(moodJournal));
            updateMoodCalendar();
        }

        function updateMoodCalendar() {
            moodCalendar.innerHTML = '';
            const moodJournal = JSON.parse(localStorage.getItem('moodJournal') || '{}');
            const today = new Date();
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            currentMonthDisplay.textContent = currentCalendarDate.toLocaleString('default', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                const emptyDiv = document.createElement('div');
                moodCalendar.appendChild(emptyDiv);
            }

            for (let day = 1; day <= lastDate; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                dayDiv.textContent = day;

                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const moodEmoji = moodJournal[dateString];

                if (moodEmoji) {
                    dayDiv.classList.add('bg-gray-700');
                    const moodDot = document.createElement('div');
                    moodDot.className = 'mood-dot';
                    moodDot.style.backgroundColor = MOOD_COLORS[moodEmoji] || '#94a3b8';
                    dayDiv.appendChild(moodDot);
                } else {
                    dayDiv.classList.add('bg-gray-800');
                }

                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    dayDiv.classList.add('border-2', 'border-blue-500');
                }

                moodCalendar.appendChild(dayDiv);
            }
        }
        
        function changeMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            updateMoodCalendar();
        }

        // --- Journaling Vault ---
        function showJournalVault() {
            const storedPin = localStorage.getItem('journalPin');
            if (storedPin) {
                openModal('pin-modal');
            } else {
                openModal('set-pin-modal');
            }
            grantBadge('first_journal');
        }

        function checkPin() {
            const storedPin = localStorage.getItem('journalPin');
            const inputPin = setPinInput.value;
            if (inputPin === storedPin) {
                 const journalEntry = document.getElementById('journal-entry');
                 const entries = JSON.parse(localStorage.getItem('journalEntries') || '[]').map(entry => atob(entry));
                 journalEntry.value = entries.join('\n\n---\n\n');
                 closeModal('pin-modal');
                 openModal('journal-modal');
                 pinInput.value = '';
            } else {
                pinError.classList.remove('hidden');
            }
        }

        function setPin() {
            const newPin = setPinInput.value;
            if (newPin.length === 4) {
                localStorage.setItem('journalPin', newPin);
                addMessage("system", "PIN for your journal has been set!");
                closeModal('set-pin-modal');
                showJournalVault();
            } else {
                // Should show a message to enter 4 digits
            }
        }
        
        // --- SOS Plan ---
        function showSosPlan() {
            const storedPlan = localStorage.getItem('sosPlan') || '';
            sosPlanInput.value = storedPlan;
            openModal('sos-modal');
        }

        function saveSosPlan() {
            const newPlan = sosPlanInput.value;
            localStorage.setItem('sosPlan', newPlan);
            addMessage("system", "Your Quick SOS Plan has been saved!");
            closeModal('sos-modal');
        }

        // --- Wellness Challenges ---
        function renderChallenges() {
            challengeDaysContainer.innerHTML = '';
            const challengeProgress = JSON.parse(localStorage.getItem('challengeProgress') || '{}');
            const today = new Date().toISOString().split('T')[0];
            const currentDay = challengeProgress.currentDay || 1;
            const lastCompletionDate = challengeProgress.lastCompletionDate || null;
            
            for (let i = 1; i <= 7; i++) {
                const dayDot = document.createElement('div');
                dayDot.className = `w-4 h-4 rounded-full border-2 transition-colors flex items-center justify-center`;
                dayDot.textContent = i;
                if (i < currentDay) {
                    dayDot.classList.add('bg-green-500', 'border-green-500');
                } else if (i === currentDay) {
                    dayDot.classList.add('bg-yellow-400', 'border-yellow-400', 'font-bold');
                } else {
                    dayDot.classList.add('bg-gray-700', 'border-gray-500');
                }
                challengeDaysContainer.appendChild(dayDot);
            }
            
            currentDayNum.textContent = currentDay;
            currentChallengeTask.textContent = CHALLENGES[currentDay - 1] || "Challenge complete! Start a new one.";
            if (currentDay > 7) {
                document.querySelector('#challenge-container button').textContent = "Challenge Complete!";
                document.querySelector('#challenge-container button').disabled = true;
                grantBadge('challenge_complete');
            } else {
                document.querySelector('#challenge-container button').textContent = `Complete Day ${currentDay}`;
                document.querySelector('#challenge-container button').disabled = false;
            }
        }

        function completeChallengeDay() {
            let challengeProgress = JSON.parse(localStorage.getItem('challengeProgress') || '{}');
            const today = new Date().toISOString().split('T')[0];
            const lastCompletionDate = challengeProgress.lastCompletionDate;
            
            if (lastCompletionDate === today) {
                return;
            }
            
            const currentDay = (challengeProgress.currentDay || 0) + 1;
            challengeProgress.currentDay = currentDay;
            challengeProgress.lastCompletionDate = today;
            localStorage.setItem('challengeProgress', JSON.stringify(challengeProgress));
            renderChallenges();
        }

        // --- UI Interactions ---
        moodOptions.forEach(option => {
            option.addEventListener('click', () => {
                const selectedMood = option.dataset.mood;
                selectMood(selectedMood);
                saveMoodEntry(selectedMood);
                document.body.style.setProperty('--bg-color', MOOD_COLORS[selectedMood] || '#1a1a1a');
            });
        });

        function selectMood(selectedMood) {
            mood = selectedMood;
            moodOptions.forEach(option => {
                option.classList.remove('bg-gray-800');
                if (option.dataset.mood === selectedMood) {
                    option.classList.add('bg-gray-800');
                }
            });
            document.body.style.setProperty('--bg-color', MOOD_COLORS[selectedMood] || '#1a1a1a');
        }
        
        function toggleVentingMode() {
            ventingMode = !ventingMode;
            if (ventingMode) {
                ventBtn.classList.remove('hidden');
                document.querySelector('#chat-container').classList.add('bg-gray-700/50');
                userInput.placeholder = "Just vent here, I'm listening without judgment...";
            } else {
                ventBtn.classList.add('hidden');
                document.querySelector('#chat-container').classList.remove('bg-gray-700/50');
                userInput.placeholder = "Ask MindMate anything...";
            }
        }

        function saveGoal() {
            saveState();
            addMessage("system", `Your goal has been saved: "${goalInput.value}".`);
        }

        function handleInput(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function displayPlaylist() {
            const playlistContainer = document.getElementById('playlist-container');
            playlistContainer.innerHTML = '';
            
            const iframe = document.createElement('iframe');
            iframe.src = MOOD_PLAYLISTS[mood];
            iframe.width = "100%";
            iframe.height = "250";
            iframe.setAttribute("allow", "autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture");
            iframe.setAttribute("loading", "lazy");
            playlistContainer.appendChild(iframe);
        }

        // --- Core Chat Logic ---
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // Check if API key is a placeholder and provide instructions
            if (API_KEY === "PASTE_YOUR_API_KEY_HERE") {
                const placeholder = addMessage("assistant", "...");
                updateMessage(placeholder, "Please replace 'PASTE_YOUR_API_KEY_HERE' with your actual Google AI Studio API key in the code to enable the chat functionality. You can find this near the top of the script section.");
                console.error("API key is not set. Please update the API_KEY constant in the code.");
                return;
            }

            updateStreak();
            
            tipCard.classList.add('hidden');
            crisisCard.classList.add('hidden');

            const autoMood = getSentiment(text);
            selectMood(autoMood);
            saveMoodEntry(autoMood);
            
            addMessage("user", text);
            userInput.value = '';
            
            // Start the break timer
            startBreakTimer();

            const isCrisis = CRISIS_PATTERNS.some(pattern => pattern.test(text));
            if (isCrisis) {
                displayCrisisResources();
                return; // Stop further processing if crisis is detected
            }
            
            const placeholder = addMessage("assistant", "...");
            
            let currentSystemPrompt = BASE_SYSTEM_PROMPT;
            const selectedPersona = PERSONAS[personaSelector.value];
            
            currentSystemPrompt += `\n\n- PERSONA: Adopt the persona of a ${selectedPersona.name}. ${selectedPersona.prompt}`;
            
            const userGoal = localStorage.getItem('userGoal');
            if (userGoal) {
                currentSystemPrompt += `\n\n- USER'S GOAL: The user's personal goal is "${userGoal}". Integrate this goal into your motivational responses when appropriate.`;
            }

            if (ventingMode) {
                currentSystemPrompt = `
                    You are a compassionate, non-judgmental space for the user to vent. Your only job is to listen and acknowledge their raw emotions without trying to fix anything. Use very brief, validating responses. For example, "I hear you," or "That sounds really tough." Do not offer advice unless explicitly asked.
                    `;
            } 
            
            const payload = {
                contents: [{ parts: [{ text: text }] }],
                systemInstruction: {
                    parts: [{ text: currentSystemPrompt }]
                },
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                let aiResponse = result.candidates[0].content.parts[0].text;
                
                // Cognitive Distortion Catcher
                for (const distortion in COGNITIVE_DISTORTIONS) {
                    if (aiResponse.includes(distortion)) {
                        aiResponse = COGNITIVE_DISTORTIONS[distortion];
                        break;
                    }
                }

                updateMessage(placeholder, aiResponse, true);
                speak(aiResponse);
                displayQuickTip();
                chatHistory.push({ role: 'user', content: text });
                chatHistory.push({ role: 'assistant', content: aiResponse });
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
                generateAffirmation();
                
                if (autoMood === 'üò® Anxious' || autoMood === 'üòü Stressed' || autoMood === 'üòî Sad') {
                    addMessage('system', "I sense you might be feeling a bit overwhelmed. Would you like to try a 1-minute guided breathing exercise?");
                }

            } catch (error) {
                updateMessage(placeholder, "I'm sorry, I'm having trouble connecting right now. Please try again later.");
                console.error("Fetch error:", error);
            }
        }
        
        // --- Smart Break Reminders ---
        function startBreakTimer() {
            if (chatTimer) clearTimeout(chatTimer);
            chatTimer = setTimeout(() => {
                const text = "You've been chatting for a while. Would you like to try a 1-minute breathing break?";
                addMessage('system', text);
            }, 5 * 60 * 1000); // 5 minutes
        }

        function addMessage(role, text, withVoiceBtn = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            const avatarEmoji = role === 'user' ? 'üë§' : AVATARS[localStorage.getItem('buddyAvatar') || 'robot'];
            const avatar = `<div class="flex-shrink-0 w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-xs font-semibold">${avatarEmoji}</div>`;
            const messageContent = role === 'user' ? text : text.replace(/\n/g, '<br>');
            let voiceBtnHtml = '';
            if (withVoiceBtn) {
                 voiceBtnHtml = `
                    <button class="ml-2 w-6 h-6 bg-gray-600 hover:bg-gray-500 rounded-full flex items-center justify-center text-white" onclick="pronounceText(this)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
                    </button>
                 `;
            }
            messageDiv.innerHTML = `
                <div class="flex items-start gap-3 max-w-[75%]">
                    ${role === 'user' ? '' : avatar}
                    <div class="flex flex-col items-start">
                      <div class="bg-gray-700 rounded-xl p-4 text-sm break-words whitespace-pre-wrap flex items-center">
                          <span class="message-text">${messageContent}</span>
                          ${voiceBtnHtml}
                      </div>
                    </div>
                    ${role === 'user' ? avatar : ''}
                </div>
            `;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageDiv.querySelector('.message-text');
        }

        function updateMessage(element, newText, withVoiceBtn = false) {
            element.innerHTML = newText.replace(/\n/g, '<br>');
            if (withVoiceBtn) {
                const parentDiv = element.closest('.flex.items-start');
                if (parentDiv && !parentDiv.querySelector('.lucide-volume-2')) {
                    const voiceBtnHtml = `
                        <button class="ml-2 w-6 h-6 bg-gray-600 hover:bg-gray-500 rounded-full flex items-center justify-center text-white" onclick="pronounceText(this)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>
                        </button>
                    `;
                    element.innerHTML += voiceBtnHtml;
                }
            }
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function displayInitialMessage() {
            const initialPrompt = "Hi there. I'm MindMate, a safe space to talk. How can I support you today?";
            addMessage("assistant", initialPrompt, true);
        }

        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            synthesis.speak(utterance);
        }

        function stopSpeaking() {
            synthesis.cancel();
        }

        function pronounceText(buttonElement) {
             const messageText = buttonElement.closest('.bg-gray-700').querySelector('.message-text').textContent;
             speak(messageText);
        }
        
        // --- AI-Powered Affirmations ---
        async function getMotivationalQuote() {
            const quotePrompt = "Generate a single, short, and motivational quote for a user.";
            const payload = { contents: [{ parts: [{ text: quotePrompt }] }] };
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const quote = result.candidates[0].content.parts[0].text;
                addMessage("system", `**Quick Motivation:**<br>${quote}`);
            } catch (error) {
                addMessage("system", "Keep going! You're doing great.");
            }
        }
        async function generateAffirmation() {
            const storedAffirmationDate = localStorage.getItem('affirmationDate');
            const today = new Date().toDateString();
            
            // Only generate a new affirmation once per day
            if (storedAffirmationDate === today) {
                dailyAffirmation.textContent = localStorage.getItem('dailyAffirmation');
                return;
            }

            const goal = localStorage.getItem('userGoal') || "improving mental wellness";
            const moodPrompt = `Generate a short, positive affirmation for a user who is currently feeling ${mood.split(' ')[1]} and is working towards the goal of "${goal}".`;
            const payload = {
                contents: [{ parts: [{ text: moodPrompt }] }]
            };
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const newAffirmation = result.candidates[0].content.parts[0].text;
                dailyAffirmation.textContent = newAffirmation;
                localStorage.setItem('dailyAffirmation', newAffirmation);
                localStorage.setItem('affirmationDate', today);
            } catch (error) {
                // Fallback to a random static affirmation
                const randomIndex = Math.floor(Math.random() * AFFIRMATIONS.length);
                const staticAffirmation = AFFIRMATIONS[randomIndex];
                dailyAffirmation.textContent = staticAffirmation;
                localStorage.setItem('dailyAffirmation', staticAffirmation);
                localStorage.setItem('affirmationDate', today);
            }
        }
        function displayDailyAffirmation() {
            generateAffirmation();
        }

        function displayQuickTip() {
            const tipText = MOOD_SUGGESTIONS[mood] || "Take a deep breath. You're doing your best and that matters.";
            tipCard.classList.remove('hidden');
            tipContent.textContent = tipText;
            displayPlaylist();
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function displayCrisisResources() {
            crisisCard.classList.remove('hidden');
            const storedPlan = localStorage.getItem('sosPlan');
            if(storedPlan) {
                sosPlanDisplay.textContent = storedPlan;
                sosPlanDisplay.classList.remove('hidden');
            } else {
                sosPlanDisplay.classList.add('hidden');
            }
            crisisResources.innerHTML = HELPLINES.map(h => {
                let text = `${h.country} - ${h.service}`;
                if (h.number) text += ` - Call: ${h.number}`;
                if (h.url) text += ` - <a href="${h.url}" class="underline text-blue-400" target="_blank">Website</a>`;
                return `<div class="p-2 bg-red-700/50 rounded-lg mt-2">${text}</div>`;
            }).join('');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function changeAvatar(avatar) {
            localStorage.setItem('buddyAvatar', avatar);
            addMessage("system", `Your MindMate avatar is now a ${avatar}.`);
        }

        // --- Voice Input/Output ---
        function toggleVoiceInput() {
            if (isListening) {
                recognition.stop();
                isListening = false;
                voiceInputBtn.classList.remove('bg-red-500');
            } else {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                recognition.continuous = false;

                let finalTranscript = '';
                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }
                    userInput.value = finalTranscript + interimTranscript;
                };

                recognition.onend = () => {
                    isListening = false;
                    voiceInputBtn.classList.remove('bg-red-500');
                    if (userInput.value.trim() !== '') {
                        sendMessage();
                    }
                };

                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    isListening = false;
                    voiceInputBtn.classList.remove('bg-red-500');
                };

                recognition.start();
                isListening = true;
                voiceInputBtn.classList.add('bg-red-500');
            }
        }
        
        // --- Guided Meditation ---
        function startGuidedBreathing() {
            openModal('breathing-modal');
            const breathingStates = ["Breathe In...", "Hold...", "Breathe Out...", "Hold..."];
            let stateIndex = 0;
            
            breathingText.textContent = breathingStates[0];
            breathingCircle.style.animationDuration = '4s';

            breathingTimer = setInterval(() => {
                stateIndex = (stateIndex + 1) % breathingStates.length;
                breathingText.textContent = breathingStates[stateIndex];
            }, 1000);
        }

        function stopBreathing() {
            clearInterval(breathingTimer);
            breathingCircle.style.animation = 'none';
            closeModal('breathing-modal');
        }

        let meditationAudio = new SpeechSynthesisUtterance();
        let meditationIndex = 0;
        let meditationIsPlaying = false;
        
        function startGuidedMeditation() {
            openModal('meditation-modal');
            meditationText.textContent = GUIDED_MEDITATION_TEXT[0];
            meditationToggleBtn.textContent = 'Play';
            meditationToggleBtn.onclick = toggleMeditation;
            meditationIndex = 0;
        }

        function toggleMeditation() {
            if (meditationIsPlaying) {
                synthesis.pause();
                meditationIsPlaying = false;
                meditationToggleBtn.textContent = 'Resume';
            } else {
                synthesis.resume();
                meditationIsPlaying = true;
                meditationToggleBtn.textContent = 'Pause';
                if (meditationIndex === 0) {
                    playMeditationStep();
                }
            }
        }
        
        function playMeditationStep() {
            if (meditationIndex >= GUIDED_MEDITATION_TEXT.length) {
                meditationIsPlaying = false;
                meditationToggleBtn.textContent = 'Done';
                grantBadge('breathing_5');
                return;
            }
            meditationAudio.text = GUIDED_MEDITATION_TEXT[meditationIndex];
            meditationText.textContent = GUIDED_MEDITATION_TEXT[meditationIndex];
            synthesis.speak(meditationAudio);
            meditationAudio.onend = () => {
                meditationIndex++;
                setTimeout(playMeditationStep, 2000); // 2 second pause between steps
            };
        }
        
        function saveJournalEntry() {
            const journalEntry = document.getElementById('journal-entry');
            if (journalEntry.value.trim() === "") {
                closeModal('journal-modal');
                return;
            }
            const entries = JSON.parse(localStorage.getItem('journalEntries') || '[]');
            const newEntry = btoa(journalEntry.value);
            entries.push(newEntry);
            localStorage.setItem('journalEntries', JSON.stringify(entries));
            addMessage("system", "Your journal entry has been saved securely.");
            closeModal('journal-modal');
        }

        // --- Community Board ---
        function showCommunityBoard() {
            openModal('community-modal');
            renderCommunityPosts();
        }

        function renderCommunityPosts() {
            const posts = JSON.parse(localStorage.getItem('communityPosts') || '[]');
            communityPostsContainer.innerHTML = '';
            if (posts.length === 0) {
                communityPostsContainer.innerHTML = `<p class="text-gray-500 italic">No posts yet. Be the first to share something!</p>`;
            }
            posts.forEach(post => {
                const postDiv = document.createElement('div');
                postDiv.className = 'bg-gray-700 p-3 rounded-lg text-sm';
                postDiv.innerHTML = `<p class="text-blue-300 font-semibold mb-1">${post.author}</p><p>${post.content}</p><p class="text-xs text-gray-400 mt-2">${new Date(post.timestamp).toLocaleString()}</p>`;
                communityPostsContainer.prepend(postDiv);
            });
        }
        
        function postToCommunity() {
            const content = communityInput.value.trim();
            if (content === "") return;
            const posts = JSON.parse(localStorage.getItem('communityPosts') || '[]');
            const newPost = {
                author: "Anonymous",
                content: content,
                timestamp: new Date().toISOString()
            };
            posts.push(newPost);
            localStorage.setItem('communityPosts', JSON.stringify(posts));
            communityInput.value = '';
            renderCommunityPosts();
        }

        // --- Modals ---
        function openModal(id) {
            document.getElementById(id).classList.remove('hidden');
            document.getElementById(id).classList.add('flex');
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        // --- Mood Chart ---
        function showMoodChart() {
            openModal('mood-chart-modal');
            const moodJournal = JSON.parse(localStorage.getItem('moodJournal') || '{}');
            const dates = Object.keys(moodJournal).slice(-7).sort();
            const scores = dates.map(date => MOOD_SCORES[moodJournal[date]] || 3);
            
            const labels = dates.map(date => new Date(date).toLocaleDateString());
            const data = {
                labels: labels,
                datasets: [{
                    label: 'Mood Score',
                    backgroundColor: 'rgb(59, 130, 246)',
                    borderColor: 'rgb(59, 130, 246)',
                    data: scores,
                }]
            };
            const config = {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    plugins: { legend: { display: false }, title: { display: true, text: 'Weekly Mood Progression', color: '#e0e0e0' } },
                    scales: {
                        y: { beginAtZero: true, max: 5, ticks: { callback: (value) => {
                            const moodLabels = { 1: 'Bad', 2: 'So-so', 3: 'Neutral', 4: 'Good', 5: 'Great' };
                            return moodLabels[value] || '';
                        }, color: '#94a3b8' }, grid: { color: '#4a5568' } },
                        x: { ticks: { color: '#94a3b8' }, grid: { color: '#4a5568' } }
                    }
                }
            };

            const chartCanvas = document.getElementById('mood-chart');
            if (myChart) { myChart.destroy(); }
            myChart = new Chart(chartCanvas, config);
        }

        // --- AI Summary & Coping Plan ---
        async function generateSummary() {
            addMessage('assistant', 'Generating your weekly reflection...');
            const history = JSON.parse(localStorage.getItem('chatHistory') || '[]');
            const journalEntries = JSON.parse(localStorage.getItem('journalEntries') || '[]').map(entry => atob(entry));
            const combinedHistory = history.map(item => `[${item.role}]: ${item.content}`).join('\n') + `\n\n[Journal Entries]:\n${journalEntries.join('\n')}`;

            const summaryPrompt = `Based on the following chat history and journal entries, provide a short summary of the user's emotional trends, key discussion topics, and any notable progress or challenges. Also, offer one key insight.
                History: ${combinedHistory.slice(-2000)}`;
            
            const payload = {
                contents: [{ parts: [{ text: summaryPrompt }] }]
            };
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const summary = result.candidates[0].content.parts[0].text;
                addMessage('assistant', `**Weekly Reflection:**<br>${summary}`);
            } catch (error) {
                addMessage('assistant', 'Sorry, I could not generate the summary.');
            }
        }

        async function generateCopingPlan() {
            addMessage('assistant', 'Generating a personalized coping plan...');
            const planPrompt = `Based on the current mood '${mood}' and the last user message, create a simple, step-by-step coping plan. Structure it as a list of 3 actionable steps.
                User Message: ${userInput.value.trim()}`;
            
            const payload = {
                contents: [{ parts: [{ text: planPrompt }] }]
            };
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                const plan = result.candidates[0].content.parts[0].text;
                addMessage('assistant', `**Your Custom Coping Plan:**<br>${plan}`);
            } catch (error) {
                addMessage('assistant', 'Sorry, I could not generate a coping plan right now.');
            }
        }

        // --- Sharing Functionality ---
        function shareProgress() {
            const card = document.getElementById('shareable-card');
            html2canvas(card, { backgroundColor: '#111827', scale: 2 }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'mindmate_progress.png';
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }
        
    </script>
</body>
</html>
